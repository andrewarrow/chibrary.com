This documents the route mails take into storage, the workers, and the
way they queue each other. An important distinction is that a 'mail' is just
a mail with its headers stored in a string, file, or S3 Object; a 'message'
is the full Ruby object and is stored almost exclusively as S3 Objects (see
the Filer section on errors). Every mail is uniquely identified by an
eight-character 'call number'. Threads are identified by the call number of
their root message.


CachedHash
----------

The CachedHash layers Ruby hash semantics onto the S3 lsitlibrary_cachedhash
bucket for configuration data and queued jobs. Different sets of
configuration live in 'psuedodirectories' (as S3 does not actually support
directories); a full list appears at the end of this doc.


Filers
------

Messages and threads (caches of the threaded messages) are stored in S3 in
the listlibrary_archive bucket. The filers (subclasses of Filer in
lib/filer.rb) do the work of taking mails from their sources, converting
them to Mail objects, then sorting and storing those mails in the bucket.
The Filer also queues the Threader with the CachedHash keys
thread_queue/*slug*/*year*/*month* for every combination of list, year, and
month that it processed a message for.

The primary filer is the Fetcher, which retrieves mail sent to
archive@listlibrary.net via POP3. Others will include mbox and maildir
scrapers for importing old archives.

The Refiler was used to fetch and re-store messages from the S3 bucket to
correct miscategorization, metadata, and call number duplication in early
development when bugs screwed up existing data. Hopefully it will not need
to be used again and can be deleted when ListLibrary enters stable
production.

Messages use the CachedHash dir 'list_address' to look up mailing list
'slugs', their unique identifiers. The Filer stores each message as
list/*slug*/message/*year*/*month*/*call number*.

When a mailing list cannot be determined for a message, it is stored with
the slug '_listlibrary_no_list'. If there was an error in processing the
message (most commonly, an attempted overwrite of an existing message) it is
stored with exception and backtrace information at filer_failed/*call
number*. If that storage fails, the message and info are stored in the web
space in the directory filer_double_failure.


Threader
--------

The threader sorts out which messages are replies to which others and stores
entire thread trees for the renderer to build pages from.

The Threader finds jobs in the CachedHash psuedodirecotry thread_queue,
which give it a list slug, year, and month. It retrieves a cached list of
those messages from the archive at list/*slug*/message/*year*/*month* and a
list of all messages in the psuedodir of the same name.

If any messages were removed since the list was cached, the cached list is
discarded and cached threads are ignored. The threader than builds a
ThreadSet by retrieving cached threads from
list/*slug*/thread/*year*/*month*/*call number* and adding any new messages.

The threader caches all the threads and a list of messages at the locations
above. It creates a job for the Renderer at
render_queue/*slug*/*year*/*month*/*call number* for each changed thread and,
for each month, caches thread subject, call number, and message count at the
CachedHash key render/month/*slug*/*year*/*month*.


Renderer
--------

The renderer retrieves jobs from the render_queue psuedodirectory, builds
the required web page, and pushes it to the live web host. Jobs instruct it
to build pages for the threads, months, and list index pages.

Thread rendering retrieves an individual thread from S3. It uses the month's
thread metadata stored by the Threader to do next/previous links. It then
queues rendering for that thread's month.

Month rendering uses that same thread metadata to show how many messages are
in the month on each month page. It loads the threads for the entire month
to present a list of every message on the month page. It then queues
rendering for that list's index.

List rendering retrieves all of a list's monthly thread metadata to present
a table linking to month pages.

When the renderer finishes rendering a thread it queues the render job for
that thread's month; when it finishes a month it queues the list job.


CachedHash Keys
---------------

The directories are:

list/*slug*/key: Per-list configuration.

list_address/*mail address*: Slug for a mailing list. Mailing lists that
commonly use several addresses will have several keys here.

render/month/*slug*/*year*/*month*: Thread metadata for a month: call
number, subject, and message count. Generated by Threader and used by
Render for pages that don't need the entire ThreadSet for the month.

render_queue/*slug*/*year*/*month*/*call number*: Job to render an
individual thread.

render_queue/*slug*/*year*/*month*: Job to render a month.

render_queue/*slug*: Job to render a list index page.

thread_queue/*slug*/*year*/*month*: A job for the Threader.
